name: Rust CF Scan

on:
  workflow_dispatch: # Memungkinkan dijalankan secara manual
  # Workflow dijalankan otomatis tiap 6 jam
  schedule:
    - cron: '0 */6 * * *'  # Setiap 6 jam (00:00, 06:00, 12:00, 18:00 UTC)


jobs:
  update-proxies:
    runs-on: ubuntu-latest
    name: ğŸ” Scan Proxy Rust Binary

    steps:
    - name: ğŸ“‚ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GIT_TOKEN }}

    - name: ğŸ› ï¸ Install Rust Toolchain
      uses: dtolnay/rust-toolchain@stable

    - name: ğŸ“¦ Cache Cargo Dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-

    - name: ğŸ“¦ Build Rust Project (Release)
      run: cargo build --release

    - name: ğŸ§ª Give Execute Permission to Binary
      run: chmod +x ./target/release/cekproxy

    - name: ğŸš€ Run Rust Binary with PostgreSQL Sync
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
      run: |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "Starting proxy scanner..."
        echo "PostgreSQL Sync: $([ -n "$DATABASE_URL" ] && echo 'Enabled âœ…' || echo 'Disabled âš ï¸')"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        ./target/release/cekproxy
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "Scan completed. Check output above for:"
        echo "  âœ… Database ready for sync"
        echo "  âœ… Successfully synced X proxies"
        echo "  âŒ Any error messages"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

    - name: ğŸ“Š Check Scan Results
      run: |
        if [ -f Data/alive.txt ]; then
          PROXY_COUNT=$(wc -l < Data/alive.txt)
          echo "âœ… Found $PROXY_COUNT active proxies"
          echo ""
          echo "ğŸ“‹ Sample proxies (first 5):"
          head -5 Data/alive.txt
          echo ""
          echo "ğŸ“ˆ Statistics:"
          echo "  Total proxies: $PROXY_COUNT"
          echo "  File size: $(du -h Data/alive.txt | cut -f1)"

          # Country distribution
          if [ "$PROXY_COUNT" -gt 0 ]; then
            echo ""
            echo "ğŸŒ Top 5 countries:"
            cut -d',' -f3 Data/alive.txt | sort | uniq -c | sort -rn | head -5 || true
          fi

          # Database sync status
          if [ -n "${{ secrets.DATABASE_URL }}" ]; then
            echo ""
            echo "ğŸ’¾ Database: Synced âœ…"
          else
            echo ""
            echo "ğŸ’¾ Database: Not configured âš ï¸"
          fi
        else
          echo "âš ï¸ No alive.txt file generated"
          exit 1
        fi


