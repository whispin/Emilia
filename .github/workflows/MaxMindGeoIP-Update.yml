name: MaxMind GeoIP Database Update

on:
  workflow_dispatch: # Allow manual trigger
  schedule:
    - cron: '0 12 * * 3'  # Run every Wednesday at 12:00 UTC

jobs:
  update-geoip:
    runs-on: ubuntu-latest
    name: ğŸ“¥ Download MaxMind GeoIP Databases

    steps:
    - name: ğŸ“‚ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GIT_TOKEN }}

    - name: ğŸ“ Ensure Data Directory Exists
      run: mkdir -p Data

    - name: ğŸ“¥ Download GeoLite2-Country Database (Official)
      env:
        MAXMIND_LICENSE_KEY: ${{ secrets.MAXMIND_LICENSE_KEY }}
      run: |
        echo "Downloading GeoLite2-Country.mmdb from MaxMind official API..."

        # MaxMind official download URL format
        DOWNLOAD_URL="https://download.maxmind.com/app/geoip_download?edition_id=GeoLite2-Country&license_key=${MAXMIND_LICENSE_KEY}&suffix=tar.gz"

        # Download and extract
        curl -L "${DOWNLOAD_URL}" -o GeoLite2-Country.tar.gz

        if [ ! -f GeoLite2-Country.tar.gz ]; then
          echo "âŒ Failed to download GeoLite2-Country.tar.gz"
          exit 1
        fi

        # Validate response is actually gzip
        if ! file GeoLite2-Country.tar.gz | grep -q "gzip compressed"; then
          echo "âŒ Downloaded file is not gzip format. Response content:"
          cat GeoLite2-Country.tar.gz
          rm -f GeoLite2-Country.tar.gz
          exit 1
        fi

        # Extract .mmdb file from tar.gz
        tar -xzf GeoLite2-Country.tar.gz --strip-components=1 --wildcards '*.mmdb'
        mv GeoLite2-Country.mmdb Data/
        rm -f GeoLite2-Country.tar.gz

        if [ -f Data/GeoLite2-Country.mmdb ]; then
          echo "âœ… GeoLite2-Country.mmdb downloaded successfully"
          ls -lh Data/GeoLite2-Country.mmdb
        else
          echo "âŒ Failed to extract GeoLite2-Country.mmdb"
          exit 1
        fi

    - name: ğŸ“¥ Download GeoLite2-City Database (Official)
      env:
        MAXMIND_LICENSE_KEY: ${{ secrets.MAXMIND_LICENSE_KEY }}
      run: |
        echo "Downloading GeoLite2-City.mmdb from MaxMind official API..."

        # MaxMind official download URL format
        DOWNLOAD_URL="https://download.maxmind.com/app/geoip_download?edition_id=GeoLite2-City&license_key=${MAXMIND_LICENSE_KEY}&suffix=tar.gz"

        # Download and extract
        curl -L "${DOWNLOAD_URL}" -o GeoLite2-City.tar.gz

        if [ ! -f GeoLite2-City.tar.gz ]; then
          echo "âŒ Failed to download GeoLite2-City.tar.gz"
          exit 1
        fi

        # Validate response is actually gzip
        if ! file GeoLite2-City.tar.gz | grep -q "gzip compressed"; then
          echo "âŒ Downloaded file is not gzip format. Response content:"
          cat GeoLite2-City.tar.gz
          rm -f GeoLite2-City.tar.gz
          exit 1
        fi

        # Extract .mmdb file from tar.gz
        tar -xzf GeoLite2-City.tar.gz --strip-components=1 --wildcards '*.mmdb'
        mv GeoLite2-City.mmdb Data/
        rm -f GeoLite2-City.tar.gz

        if [ -f Data/GeoLite2-City.mmdb ]; then
          echo "âœ… GeoLite2-City.mmdb downloaded successfully"
          ls -lh Data/GeoLite2-City.mmdb
        else
          echo "âŒ Failed to extract GeoLite2-City.mmdb"
          exit 1
        fi

    - name: ğŸ“¥ Download GeoLite2-ASN Database (Official)
      env:
        MAXMIND_LICENSE_KEY: ${{ secrets.MAXMIND_LICENSE_KEY }}
      run: |
        echo "Downloading GeoLite2-ASN.mmdb from MaxMind official API..."

        # MaxMind official download URL format
        DOWNLOAD_URL="https://download.maxmind.com/app/geoip_download?edition_id=GeoLite2-ASN&license_key=${MAXMIND_LICENSE_KEY}&suffix=tar.gz"

        # Download and extract
        curl -L "${DOWNLOAD_URL}" -o GeoLite2-ASN.tar.gz

        if [ ! -f GeoLite2-ASN.tar.gz ]; then
          echo "âŒ Failed to download GeoLite2-ASN.tar.gz"
          exit 1
        fi

        # Validate response is actually gzip
        if ! file GeoLite2-ASN.tar.gz | grep -q "gzip compressed"; then
          echo "âŒ Downloaded file is not gzip format. Response content:"
          cat GeoLite2-ASN.tar.gz
          rm -f GeoLite2-ASN.tar.gz
          exit 1
        fi

        # Extract .mmdb file from tar.gz
        tar -xzf GeoLite2-ASN.tar.gz --strip-components=1 --wildcards '*.mmdb'
        mv GeoLite2-ASN.mmdb Data/
        rm -f GeoLite2-ASN.tar.gz

        if [ -f Data/GeoLite2-ASN.mmdb ]; then
          echo "âœ… GeoLite2-ASN.mmdb downloaded successfully"
          ls -lh Data/GeoLite2-ASN.mmdb
        else
          echo "âŒ Failed to extract GeoLite2-ASN.mmdb"
          exit 1
        fi

    - name: ğŸ“¥ Download GeoIP2-Anonymous-IP Database (Official)
      env:
        MAXMIND_LICENSE_KEY: ${{ secrets.MAXMIND_LICENSE_KEY }}
      run: |
        echo "Downloading GeoIP2-Anonymous-IP.mmdb from MaxMind official API..."
        echo "â„¹ï¸ Note: This requires a paid MaxMind GeoIP2 subscription"

        # MaxMind official download URL format for GeoIP2-Anonymous-IP
        DOWNLOAD_URL="https://download.maxmind.com/app/geoip_download?edition_id=GeoIP2-Anonymous-IP&license_key=${MAXMIND_LICENSE_KEY}&suffix=tar.gz"

        # Download and extract
        curl -L "${DOWNLOAD_URL}" -o GeoIP2-Anonymous-IP.tar.gz

        if [ ! -f GeoIP2-Anonymous-IP.tar.gz ]; then
          echo "âš ï¸ Failed to download GeoIP2-Anonymous-IP.tar.gz - may require paid subscription"
          echo "â„¹ï¸ Skipping Anonymous-IP database (filtering will be disabled)"
          exit 0
        fi

        # Validate response is actually gzip
        if ! file GeoIP2-Anonymous-IP.tar.gz | grep -q "gzip compressed"; then
          echo "âš ï¸ Downloaded file is not gzip format. This may require a paid GeoIP2 subscription."
          echo "Response content (first 200 chars):"
          head -c 200 GeoIP2-Anonymous-IP.tar.gz
          rm -f GeoIP2-Anonymous-IP.tar.gz
          echo "â„¹ï¸ Skipping Anonymous-IP database (filtering will be disabled)"
          exit 0
        fi

        # Extract .mmdb file from tar.gz
        tar -xzf GeoIP2-Anonymous-IP.tar.gz --strip-components=1 --wildcards '*.mmdb'
        mv GeoIP2-Anonymous-IP.mmdb Data/
        rm -f GeoIP2-Anonymous-IP.tar.gz

        if [ -f Data/GeoIP2-Anonymous-IP.mmdb ]; then
          echo "âœ… GeoIP2-Anonymous-IP.mmdb downloaded successfully"
          ls -lh Data/GeoIP2-Anonymous-IP.mmdb
        else
          echo "âš ï¸ Failed to extract GeoIP2-Anonymous-IP.mmdb"
          echo "â„¹ï¸ Anonymous-IP filtering will be disabled"
        fi

    - name: ğŸ“Š Verify Downloaded Files
      run: |
        echo "Verifying downloaded databases..."
        echo "ğŸ“‚ Data directory contents:"
        ls -lh Data/*.mmdb || echo "No .mmdb files found"

        echo ""
        echo "ğŸ“ˆ File sizes:"
        [ -f Data/GeoLite2-Country.mmdb ] && du -h Data/GeoLite2-Country.mmdb || echo "âŒ GeoLite2-Country.mmdb missing"
        [ -f Data/GeoLite2-City.mmdb ] && du -h Data/GeoLite2-City.mmdb || echo "âŒ GeoLite2-City.mmdb missing"
        [ -f Data/GeoLite2-ASN.mmdb ] && du -h Data/GeoLite2-ASN.mmdb || echo "âŒ GeoLite2-ASN.mmdb missing"
        [ -f Data/GeoIP2-Anonymous-IP.mmdb ] && du -h Data/GeoIP2-Anonymous-IP.mmdb || echo "âš ï¸ GeoIP2-Anonymous-IP.mmdb missing"

        echo ""
        echo "ğŸ“… Last modified dates:"
        stat -c '%y %n' Data/*.mmdb 2>/dev/null || stat -f '%Sm %N' Data/*.mmdb 2>/dev/null || echo "Unable to stat files"

    - name: ğŸ“¤ Commit and Push Changes
      if: ${{ success() }}
      run: |
        git config --global user.name "Github Actions"
        git config --global user.email "actions@github.com"

        # Add the downloaded databases
        git add Data/GeoLite2-Country.mmdb
        git add Data/GeoLite2-City.mmdb
        git add Data/GeoLite2-ASN.mmdb
        git add Data/GeoIP2-Anonymous-IP.mmdb 2>/dev/null || true

        # Check if there are changes to commit
        if git diff --staged --quiet; then
          echo "â„¹ï¸ No changes to commit - databases are up to date"
        else
          git commit -m "ğŸ—ºï¸ Update MaxMind GeoIP databases"
          git push origin main
          echo "âœ… Successfully updated GeoIP databases"
        fi
      shell: bash