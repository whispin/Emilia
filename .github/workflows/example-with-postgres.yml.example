# ç¤ºä¾‹ï¼šå¸¦ PostgreSQL åŒæ­¥çš„ä»£ç†æ‰«æ Workflow
# å°†æ­¤æ–‡ä»¶é‡å‘½åä¸º .yml å¹¶é…ç½® DATABASE_URL secret åä½¿ç”¨

name: Proxy Scanner with PostgreSQL

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # æ¯ 6 å°æ—¶è¿è¡Œä¸€æ¬¡

jobs:
  scan-and-sync:
    runs-on: ubuntu-latest
    name: ğŸ” Scan Proxies and Sync to PostgreSQL

    steps:
    - name: ğŸ“‚ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GIT_TOKEN }}

    - name: ğŸ¦€ Setup Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        override: true

    - name: ğŸ“¦ Cache Cargo Dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: ğŸ”¨ Build Release
      run: cargo build --release

    - name: ğŸš€ Run Proxy Scanner with PostgreSQL Sync
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
      run: |
        echo "Starting proxy scanner with PostgreSQL integration..."
        ./target/release/cekproxy

    - name: ğŸ“Š Check Results
      run: |
        if [ -f Data/alive.txt ]; then
          echo "âœ… Found $(wc -l < Data/alive.txt) active proxies"
          echo "ğŸ“‹ Sample proxies:"
          head -5 Data/alive.txt
        else
          echo "âš ï¸ No alive.txt file generated"
        fi

    - name: ğŸ“¤ Commit and Push Changes
      if: ${{ success() }}
      run: |
        git config --global user.name "Github Actions"
        git config --global user.email "actions@github.com"

        git add Data/alive.txt

        if git diff --staged --quiet; then
          echo "â„¹ï¸ No changes to commit"
        else
          timestamp=$(date -u +"%Y-%m-%d %H:%M UTC")
          git commit -m "ğŸ”„ Update proxy list - ${timestamp}"
          git push origin main
          echo "âœ… Successfully updated proxy list"
        fi
      shell: bash